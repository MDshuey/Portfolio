---
title: "Media Monitoring of the 2020 Democratic Primaty Race"
  date: Sys.Date()
  output:
    html_document:
---
```{r setup}
library(stringr)
library(lubridate)
devtools::install_github("MDShuey/newsanchor")
library(newsanchor)
library(rlist)
#list of candidates and their names. 
# Having names don't occur often but I'm not sure if the keyword function checks article body too.
```
```{r example, eval=FALSE}
Biden <- get_everything(qInTitle = "Biden",
                        from = Sys.Date() - days(1),
                        to = Sys.Date() - days(1),
                        language = "en")
Biden
```
We make the cutoff of 100 results per query useful by sorting by popularity.
```{r cc}
pol_c <- c("Biden","Buttigieg","Sanders","Warren", "Klobuchar", "Bloomberg","Steyer", "Yang", "Bennet", "Sestak")

countcapture <- function(day_ = Sys.Date() - days(1), account_type = "developer") {
  output <- lapply(pol_c, function(pol) {
    polpull <- get_everything(qInTitle = pol,
                              from = day_, to = day_,
                              language = "en", sort_by = "popularity")
    if (polpull$metadata$status_code != 200) {stop(paste("Error:", polpull$metadata$status_code, "during candidate:", pol))}
    if (account_type != "developer"){
      if (polpull$metadata$total_results > 100) {
        times <- ceiling((polpull$metadata$total_results)/100)
        for (i in 2:length(times)){
          polpull <- list.rbind(polpull, get_everything(qInTitle = pol,
                                                        from = day_, to = day_,
                                                        language = "en", sort_by = "popularity",
                                                        page = i)
          )
        }
      }
      
    }
    polpull
  }
  )
  #finalizing output
  names(output) <- pol_c
  output
}
```

```{r testinggrounds}
#test
cc <- countcapture(day_ = '2020-01-26')
cc2 <- countcapture(day_ = "2020-01-27")
cc3 <- countcapture(day_ = "2020-01-28")
cc4 <- countcapture(day_ = "2020-01-29")
cc5 <- countcapture(day_ = "2020-01-30")
cc6 <- countcapture(day_ = "2020-01-31")


daymerge <- Map(c, cc, cc2)
daymerge <- Map(c, daymerge, cc3,cc4,cc5,cc6)

save(daymerge, file = '~/january_cc.Rdata')

cc0201 <- countcapture(day_ = "2020-02-01")
cc0202 <- countcapture(day_ = "2020-02-02")
cc0203 <- countcapture(day_ = "2020-02-3")

ccFeb <- mapply(pol_c, function(pol){
  rbind(cc0201[[pol]], cc0202[[pol]])
}, simplify = F)

newpull <- function(){
  lf <- list.files("~/GitHub/Portfolio/Part 1- Media Monitoring/countcapture", full.names = T)
  #filter just the cc names of Rdata files
  lf[[grepl("/cc/cc", lf)]]
  # now take out the date
  lastday <- str_extract("\\d\\d-\\d.", lf[[length(lf)]])
  #make the full date
  lastday <- paste0("2020-", lastday)
  if(as.Date(lastday) == Sys.date()){stop("You're all good Holmes, up-to-date!")}
  #remove the dot
  else if (grep("$", lastday, value = T) == "."){lastday <- str_split(lastday, "\\.")[1]}
  require("lubridate")
  lastday <- as.Date(lastday)
  #AOTJFT
  for (i in seq.Date(lastday, (Sys.Date()-days(1)))) {
    capture <- countcapture(day_ = i)
    save(capture, file = paste0('~/countcapture/cc/cc',as.character(i),'.Rdata'))
  }
}


pull for (i in seq.Date(lastday, (Sys.Date()-days(1)))) {
    capture <- countcapture(day_ = i)
    save(capture, file = paste0('~/countcapture/cc/cc',as.character(i),'.Rdata'))
  }


for (j in 3:29) {
  day <- paste0('2020-02-', j)
  media <- get_everything(qInTitle = "Trump",
                      language = 'en',
                      from = day, to=day,
                      sort_by = "popularity")
  save(media, file = paste0("~/countcapture/tcc02-", j, '.Rdata'))
}
tcc0203 <- get_everything(qInTitle = "Trump",
                      language = 'en',
                      from = '2020-02-03', to='2020-02-03',
                      sort_by = "popularity")

```


```{r candidate_pull}

biddy <- data("countcapture/cc01-26.Rdata")

candidate <- function(name) {
  
  list(
    metadata = do.call(rbind, lapply(list.files("countcapture"), function(file){
      file
    }))
    
    results.df = do.call(rbind, lapply(list.files("countcapture"), function(file){
      file[[name]]$results.df
    }))
  )
  }

biddy <- candidate("Biden")
